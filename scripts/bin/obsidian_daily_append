#!/bin/bash
# Quick note to Obsidian daily note via Walker dmenu

# Your Obsidian vault root
VAULT="$HOME/Documents/vault"

# Get today's date components
YEAR=$(date +%Y)
YEAR_MONTH=$(date +%Y-%m)
DAY=$(date +%Y-%m-%d)

# Build the full path
CALENDAR_PATH="$VAULT/Calendar/$YEAR/$YEAR_MONTH"
FILE="$CALENDAR_PATH/$DAY.md"

# Get the last non-empty line from the file if it exists as placeholder
if [ -f "$FILE" ]; then
    placeholder=$(grep -v '^[[:space:]]*$' "$FILE" | tail -n 1)
    # If no non-empty line found, use default
    if [ -z "$placeholder" ]; then
        placeholder="Add to daily note:"
    fi
else
    placeholder="Add to daily note:"
fi

# First prompt: Get text input
input=$(echo "" | walker -d -I -p "$placeholder")

# If input is empty, print error and exit
if [ -z "$input" ]; then
    echo "Error: no input provided" >&2
    notify-send "Obsidian Daily Note" "No text provided. Please insert text!"
    exit 1
fi

# Second prompt: Select mode (new or append)
mode=$(echo -e "new\nappend" | walker -d -p "Select mode:")

# If mode is empty, default to new
if [ -z "$mode" ]; then
    mode="new"
fi

# Ensure the directory exists
mkdir -p "$CALENDAR_PATH"

# Append based on mode
if [ "$mode" = "new" ]; then
    # New entry with timestamp
    TIME=$(date +%H:%M)
    printf "\n- %s %s" "$TIME" "$input" >>"$FILE"
else
    # Append entry with tab indentation, no timestamp
    printf "\n\t- %s" "$input" >>"$FILE"
fi

# Optional: Notify
# notify-send "Obsidian Daily Note" "Appended: $TIME $TEXT"
